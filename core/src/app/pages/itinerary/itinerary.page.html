<ion-content scrollY="false" class="webmapp-pageroute-content" id="webmapp-pageroute-main">
  <ng-container *ngIf="(mapConf$|async).alert_poi_show">
    <ng-container *ngIf="modeFullMap ">
      <ng-container *ngIf="nearestPoi$|async as nearestPoi">
        <div class="message">
          <wm-tab-nearest-poi
            [nearestPoi]="nearestPoi"
            (click)="clickPoi(nearestPoi)"
          ></wm-tab-nearest-poi>
        </div>
      </ng-container>
    </ng-container>
  </ng-container>
  <div #header class="webmapp-pageroute-header">
    <ion-header
      class="webmapp-pageroute-header"
      [ngClass]="{'webmapp-pageroute-header-hide':modeFullMap}"
    >
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-back-button
            mode="ios"
            defaultHref="back"
            text=""
            class="webmapp-backbutton webmapp-backbutton-dark"
          >
          </ion-back-button>
        </ion-buttons>
        <ion-title>{{(currentTrackProperties$|async)?.name | wmtrans}}</ion-title>
      </ion-toolbar>
      <div class="webmapp-pageroute-header-backdrop" [hidden]="opacity>0.5"></div>
    </ion-header>
  </div>

  <div #mapcontainer class="webmapp-pageroute-map-container">
    <wm-map
      #wmap
      wmMapTarget="ol-map-track"
      [wmMapConf]="mapConf$|async"
      [wmMapMap]="(wmap.map$|async)"
      [onClick]="wmap.clickEVT$"
      (wmMapRotate)="mapRotation($event)"
      wmMapTrack
      [track]="(currentTrack$|async)"
      wmMapTrackRelatedPois
      [wmMapTrackRelatedPoisAlertPoiRadius]="(mapConf$|async).alert_poi_radius"
      (wmMapTrackRelatedPoisNearestPoiEvt)="nearestPoi$.next($event)"
      (related-poi-click)="clickPoi($event)"
      wmMapPosition
      [wmMapPositionfocus]="focus$|async"
      [wmMapPositioncurrentLocation]="currentPosition$|async"
      [trackElevationChartElements]="trackElevationChartHoverElements$|async"
    >
      <ion-button
        top-right
        class="webmapp-pageroute-btnfullmap"
        [hidden]="opacity < 0.5"
        [ngClass]="{'webmapp-pageroute-btnfullmap-full':modeFullMap}"
        (click)="toogleFullMap()"
      >
        <div [hidden]="!modeFullMap">
          <ion-icon name="close-outline"></ion-icon>
        </div>
        <div [hidden]="modeFullMap">
          <ion-icon name="resize-outline"></ion-icon>
        </div>
      </ion-button>
      <webmapp-btn-orientation
        bottom-right
        class="webmapp-map-fab"
        [ngClass]="{'webmapp-pageroute-btnfullmap-full':modeFullMap}"
        [degrees]="wmap.mapDegrees"
        (click)="wmap.orientNorth()"
      >
      </webmapp-btn-orientation>
    </wm-map>
  </div>

  <div
    class="webmapp-pageroute-infopanel"
    #dragHandleContainer
    [ngClass]="{'webmapp-pageroute-infopanel-hide':modeFullMap}"
    [ngStyle]="{
      'bottom': (minInfoheight-maxInfoheight) + 'px'
    }"
  >
    <ion-card
      class="webmapp-pageroute-infopanel-card"
      [ngStyle]="{
        'height': maxInfoheight + 'px'
      }"
    >
      <div class="webmapp-pageroute-infopanel-drag" #dragHandleIcon (click)="handleClick()">
        <div class="webmapp-pageroute-infopanel-drag-handle"></div>
        <div #lessdetails class="webmapp-pageroute-infopanel-lessdetails">
          <ion-label class="webmapp-pageroute-infopanel-name">
            {{(currentTrackProperties$|async)?.name | wmtrans}}
          </ion-label>
          <ion-label *ngIf="flowPopoverText$|async as flowPopoverText">
            <div [innerHTML]="flowPopoverText"></div>
          </ion-label>
        </div>
      </div>
      <ion-content #moredetails scrollY="true" scroll-events="true" (ionScroll)="scroll($event)">
        <ng-container *ngIf="(mapConf$|async).alert_poi_show">
          <ng-container *ngIf="nearestPoi$|async as nearestPoi">
            <wm-tab-nearest-poi
              [nearestPoi]="nearestPoi"
              (click)="clickPoi(nearestPoi)"
            ></wm-tab-nearest-poi>
          </ng-container>
        </ng-container>
        <webmapp-tab-detail
          class="webmapp-route-tab"
          (slopeChartHover)="setTrackElevationChartHoverElements($event)"
        ></webmapp-tab-detail>
        <webmapp-tab-howto class="webmapp-route-tab"></webmapp-tab-howto>
        <webmapp-tab-description class="webmapp-route-tab"></webmapp-tab-description>
        <ng-container *ngIf="(currentTrackProperties$|async)?.audio">
          <ion-title>{{'Descrizione Audio'|wmtrans}}</ion-title>
          <wm-track-audio [audio]="(currentTrackProperties$|async)?.audio"></wm-track-audio>
        </ng-container>
      </ion-content>
    </ion-card>
  </div>

  <div class="webmapp-pageroute-downloadbackpanel" [hidden]="!showDownload"></div>
  <div class="webmapp-pageroute-downloadpanel" [hidden]="!showDownload">
    <div class="webmapp-pageroute-downloadpanel-container">
      <ion-img
        class="webmapp-pageroute-downloadpanel-logo"
        src="assets/images/logo46.png"
      ></ion-img>
      <i
        class="webmapp-pageroute-downloadpanel-exit icon-outline-close-outline"
        (click)="endDownload(true)"
      >
      </i>
      <webmapp-download-panel
        (changeStatus)="downloadStatus($event)"
        (exit)="endDownload()"
      ></webmapp-download-panel>
    </div>
  </div>

  <ion-fab
    [vertical]="'top'"
    horizontal="end"
    class="webmapp-pageroute-fabbottom webmapp-pageroute-fabbottom-top"
    [ngClass]="{'webmapp-pageroute-fabbottom-top-fullmap':modeFullMap}"
  >
  </ion-fab>

  <ion-fab
    vertical="top"
    horizontal="start"
    [ngStyle]="{      'opacity': opacity    }"
    *ngIf="false"
  >
    <ion-fab-button (click)="back()" size="small" class="webmapp-pageroute-btntop">
      <i class="webmapp-icon-chevron-left-outline"></i>
    </ion-fab-button>
  </ion-fab>

  <div
    *ngIf="(focus$|async) === false"
    class="webmapp-pageroute-toolbox"
    [ngClass]="
    {'webmapp-pageroute-toolbox-over':showToolBarOver && opacity < 0.9,
    'webmapp-pageroute-toolbox-hide':opacity < 0.9,
    'webmapp-pageroute-toolbox-hideover':hideToolBarOver,
    'webmapp-pageroute-toolbox-fullmap':modeFullMap}"
  >
    <div
      (click)="download()"
      *ngIf="(currentTrackProperties$|async)?.size == null"
      class="webmapp-pageroute-toolbox-button ion-activatable"
    >
      <i class="icon-outline-donwload"></i>
      {{ 'pages.route.btndownload' | wmtrans }}
      <ion-ripple-effect></ion-ripple-effect>
    </div>

    <div (click)="share()" class="webmapp-pageroute-toolbox-button ion-activatable">
      <i class="icon-outline-share-outline"></i>
      {{ 'pages.route.btnshare' | wmtrans }}
      <ion-ripple-effect></ion-ripple-effect>
    </div>

    <div (click)="navigate()" class="webmapp-pageroute-toolbox-button ion-activatable">
      <i class="icon-outline-nav-outline"></i>
      {{ 'pages.route.btndnavigate' | wmtrans }}
      <ion-ripple-effect></ion-ripple-effect>
    </div>

    <div
      *ngIf="(authEnable$|async) && (isLoggedIn$|async)"
      (click)="favourite()"
      class="webmapp-pageroute-toolbox-button ion-activatable"
    >
      <i *ngIf="isFavourite$|async" class="icon-fill-heart"></i>
      <i *ngIf="!(isFavourite$|async)" class="icon-outline-heart"></i>
      {{ 'pages.route.btnfavourite' | wmtrans }}
      <ion-ripple-effect></ion-ripple-effect>
    </div>
  </div>
</ion-content>
